/*
* This file was automatically generated using Avlos.
* https://github.com/tinymovr/avlos
*
* Any changes to this file will be overwritten when
* content is regenerated.
*/

{%- macro getter_byval(attr) -%}
    if (AVLOS_CMD_READ == cmd) {
        {{attr.dtype.c_name}} v;
        v = {{ attr.getter_name }}();
        *buffer_len = sizeof(v);
        memcpy(buffer, &v, sizeof(v));
        return AVLOS_RET_READ;
    }
{%- endmacro %}

{%- macro getter_char(attr) -%}
    if (AVLOS_CMD_READ == cmd) {
        return _avlos_getter_string(buffer, buffer_len, {{ attr.getter_name }});
    }
{%- endmacro %}

{%- macro setter_byval(attr) -%}
    {% if attr.getter_name %}else {% endif %}if (AVLOS_CMD_WRITE == cmd) {
        {{attr.dtype.c_name}} v;
        memcpy(&v, buffer, sizeof(v));
        {{ attr.setter_name }}(v);
        return AVLOS_RET_WRITE;
    }
{%- endmacro %}

{%- macro setter_char(attr) -%}
    {% if attr.getter_name %}else {% endif %}if (AVLOS_CMD_WRITE == cmd) {
        return _avlos_setter_string(buffer, {{ attr.setter_name }});
    }
{%- endmacro %}

{%- for include in includes %}
#include {{ include | as_include }}
{%- endfor %}

static inline uint8_t _avlos_getter_string(uint8_t *buffer, uint8_t *buffer_len, uint8_t (*getter)(char*)) {
    *buffer_len = getter((char *)buffer);
    return AVLOS_RET_READ;
}

static inline uint8_t _avlos_setter_string(const uint8_t *buffer, void (*setter)(const char*)) {
    setter((const char *)buffer);
    return AVLOS_RET_WRITE;
}

{% set comma = joiner(", ") %}
uint8_t (*avlos_endpoints[{{ instance | endpoints | length }}])(uint8_t * buffer, uint8_t * buffer_len, Avlos_Command cmd) = { {%- for attr in instance | endpoints %}{{ comma() }}&{{attr.endpoint_function_name}}{%- endfor %} };

uint32_t _avlos_get_proto_hash(void)
{
    return avlos_proto_hash;
}

{%- for attr in instance | endpoints %}

{% if attr.func_attr -%}{{attr.func_attr}} {% endif %}uint8_t {{attr.endpoint_function_name}}(uint8_t * buffer, uint8_t * buffer_len, Avlos_Command cmd)
{
    {%- if attr.getter_name %}

        {%- if attr.getter_strategy == "string" %}
{{ getter_char(attr) }}
        {%- else %}
{{ getter_byval(attr) }}
        {%- endif %}

    {%- endif %}
    {%- if attr.setter_name %}

        {%- if attr.setter_strategy == "string" %}
{{ setter_char(attr) }}
        {%- else %}
{{ setter_byval(attr) }}
        {%- endif %}

    {%- endif %}
    {%- if attr.caller_name %}
        {%- if attr.arguments | length > 0 %}
    uint8_t _offset = 0;
        {%- endif %}
    {%- for arg in attr.arguments %}
    {{ arg.dtype.c_name }} {{arg.name}};
    memcpy(&{{arg.name}}, buffer+_offset, sizeof({{arg.name}}));
    _offset += sizeof({{arg.name}});
    {%- endfor %}

    {%- set comma = joiner(", ") %}
    {%- if attr.dtype.c_name != "void" %}
    {{attr.dtype.c_name}} ret_val = {{ attr.caller_name }}({%- for arg in attr.arguments %}{{ comma() }}{{ arg.name }} {%- endfor %});
    memcpy(buffer, &ret_val, sizeof(ret_val));
    *buffer_len = sizeof(ret_val);
    {%- else %}
    {{ attr.caller_name }}({%- for arg in attr.arguments %}{{ comma() }}{{ arg.name }} {%- endfor %});
    {%- endif %}

    return AVLOS_RET_CALL;
    {%- else %}
    return AVLOS_RET_NOACTION;
    {%- endif %}
}

{%- endfor %}
